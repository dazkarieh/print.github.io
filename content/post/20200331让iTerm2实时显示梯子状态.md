+++
title= "è®©iTerm2å®æ—¶æ˜¾ç¤ºæ¢¯å­çŠ¶æ€"
date= 2020-03-31T16:38:34+08:00
type = "post"
toc = true
categories = ["æŠ€æœ¯"]
comments = false
reward = true
mathjax = false
codes = ["bash"]
slug = "how iTerm2 show current proxy status"
keywords = ["iTerm2","zsh","proxy"]
tags = ["iTerm2","zsh"]
+++
ä½œä¸ºæ—¥å¸¸ç¿»å¢™çš„ä¸è½¨åˆ†å­ä¹‹ä¸€ï¼Œå¸¸é‡åˆ°éœ€è¦ä¼šè°ƒç”¨curlã€wgetã€brewç­‰è¿›è¡Œä»£ç†ä¸‹è½½çš„æ—¶å€™ï¼Œè¿™æ—¶å€™ç¢°å£æ˜¯æœ€æ’•å¿ƒè£‚è‚ºçš„ã€‚é€šå¸¸æœ€çœåŠ›çš„åšæ³•æ˜¯è£…ä¸ªä»£ç†å¼€å…³ï¼Œæ—©å‰ä¹Ÿæœ‰å†™è¿‡ç›¸å…³ç®€æ¡ˆã€Š[ç»™zshæ¥æŠŠç¿»å¢™å¼¹æ¤…]({{< relref"20190707ä¸ºä½ çš„zshå®‰è£…ç¿»å¢™å¼¹æ¤….md#ä¸ºzshé…ç½®socksä»£ç†å¼€å…³" >}})ã€‹ã€‚

ä½†é—®é¢˜æ¥äº†ï¼Œæ—¶é—´ä¸€é•¿ï¼Œå´å¸¸å°†å½“å‰sessionæŠ›ä¹‹è„‘åè€Œæ— æ³•åˆ†è¾¨å½“å‰è¿æ¥çŠ¶æ€ï¼Œè¿™å°±æ˜¯æœ¬æ–‡çš„æ¥ç¼˜äº†ã€‚
<!--more-->

## æ–¹æ¡ˆä¸€ï¼šå¢å¼ºå‹function

ä¿®æ”¹`~/.zshrc`

åŠ å…¥ä¸‹åˆ—å†…å®¹ï¼š

```bash
export proxy_host=127.0.0.1
export proxy_port=1080//è‡ªå®šä¹‰æ¢¯å­ç«¯å£
export switch_proxy=0
export cdc_in=0

function pp(){
	if [ $switch_proxy = 0 ]; then
    export http_proxy="$proxy_host:$proxy_port"
    export https_proxy="$proxy_host:$proxy_port"
    export ftp_proxy="$proxy_host:$proxy_port"
    export GOPROXY="$proxy_host:$Proxy_port"
    switch_proxy=l
    echo -e "æ¢¯å­æ¨¡å¼"
  else

    unset http_proxy
    unset https_proxy
    unset ftp_proxy
    unset GOPROXY
    switch_proxy=0

    echo -e "å’Œè°æ¨¡å¼"
  fi
}
```

## æ–¹æ¡ˆäºŒï¼šiTerm2  badgeåŠŸèƒ½

å…ˆå®‰è£… Shell Integration[^1]ï¼Œä»¥zshä¸ºä¾‹ï¼š

```bash
$ curl -L https://iterm2.com/shell_integration/zsh \
-o ~/.iterm2_shell_integration.zsh
```

é‡æ–°åŠ è½½é…ç½®

```bash
$ source ~/.iterm2_shell_integration.zsh
```

å¾€`~/.zshrc` æ·»åŠ è„šæœ¬å†…å®¹[^2]ï¼š

```bash
function iterm2_print_user_vars() {
 iterm2_set_user_var proxy $([ -z "$http_proxy" ] || echo "ãŠ™ï¸ğŸ…¿ï¸")
}
```

æ‰“å¼€iTerm2 ï¼Œå°†Preferences -> Profiles -> General -> Badge[^3] è®¾ç½®ä¸º `\(user.proxy)`


æœ€ç»ˆï¼Œæˆ‘ç»“åˆäº†ä¸Šè¿°ä¸¤ç§åŠæ³•ï¼Œåˆ¶ä½œäº†åŒä¿é™©æ–¹æ¡ˆï¼Œæ•ˆæœå¦‚ä¸‹ï¼š

* é”®å…¥`pp`ï¼Œè¿›å…¥æ¢¯å­æ¨¡å¼

{{< img src="https://ian2.oss-cn-hangzhou.aliyuncs.com/clt6/20200331202206.png" alt="æ¢¯å­æ¨¡å¼" >}}

* å†æ¬¡é”®å…¥`pp`ï¼Œé€€å‡ºæ¢¯å­çŠ¶æ€ï¼Œå›é€€åˆ°å’Œè°æ¨¡å¼

{{< img src="https://ian2.oss-cn-hangzhou.aliyuncs.com/clt6/20200331202257.png" alt="å’Œè°æ¨¡å¼"  >}}


## æ–¹æ¡ˆä¸‰ï¼šproxychains

ä½†åœ¨å®é™…åº”ç”¨ä¸­ï¼Œç”±äºç»å¸¸åœ¨clashXä¸v2rayuä¹‹é—´åˆ‡æ¢ï¼Œppç»å¸¸ä¸æ˜¯ç‰¹åˆ«çµå…‰ï¼Œäºæ˜¯åˆåŠ äº†ç¬¬ä¸‰é‡ä¿é™©ï¼šproxychians-ng[^4]ï¼š

```bash
$ brew install proxychains-ng
```
proxychains-ngé»˜è®¤é…ç½®æ–‡ä»¶åä¸º`proxychains.conf`ã€‚

* é€šè¿‡æºä»£ç ç¼–è¯‘å®‰è£…çš„é»˜è®¤ä¸º  /etc/proxychains.conf
* Macä¸‹ç”¨Homebrewå®‰è£…çš„é»˜è®¤ä¸º /usr/local/etc/proxychains.conf

```bash
$ vi /usr/local/etc/proxychains.conf
```

ä¿®æ”¹å¯èƒ½ä¼šç”¨åˆ°çš„å¯¹åº”åè®®åŠç«¯å£å³å¯ï¼š

```bash
[ProxyList]
socks5  127.0.0.1 1080 # v2rayUç«¯å£
http    127.0.0.1 1089 # v2rayUç«¯å£
socks5  127.0.0.1 7891 # ClashXç«¯å£
http    127.0.0.1 7890 # ClashXç«¯å£
```
æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µé€‰æ‹©proxychains-ngçš„ä»£ç†æ¨¡å¼ï¼š

* dynamic_chain ï¼šåŠ¨æ€æ¨¡å¼,æŒ‰ç…§ä»£ç†åˆ—è¡¨é¡ºåºè‡ªåŠ¨é€‰å–å¯ç”¨ä»£ç†
* strict_chain ï¼šä¸¥æ ¼æ¨¡å¼,ä¸¥æ ¼æŒ‰ç…§ä»£ç†åˆ—è¡¨é¡ºåºä½¿ç”¨ä»£ç†ï¼Œæ‰€æœ‰ä»£ç†å¿…é¡»å¯ç”¨
* round_robin_chain ï¼šè½®è¯¢æ¨¡å¼ï¼Œè‡ªåŠ¨è·³è¿‡ä¸å¯ç”¨ä»£ç†
* random_chain ï¼šéšæœºæ¨¡å¼,éšæœºä½¿ç”¨ä»£ç†

å»ºè®®ï¼šç¼–è¾‘`vi ~/.zshrc`ï¼ŒåŠ å…¥åˆ«åæ˜ å°„

```bash
alias pc='proxychains4'
```
æµ‹è¯•ï¼š

```bash
$ pc curl ip.cc
[proxychains] config file found: /usr/local/etc/proxychains.conf
[proxychains] preloading /usr/local/Cellar/proxychains-ng/4.14/lib/libproxychains4.dylib
[proxychains] DLL init: proxychains-ng 4.14
[proxychains] Dynamic chain  ...  127.0.0.1:7891  ...  timeout
[proxychains] Dynamic chain  ...  127.0.0.1:1080  ...  cip.cc:80  ...  OK
IP	: 103.17.10.50
åœ°å€	: ä¸­å›½  å°æ¹¾  æ–°åŒ—å¸‚
è¿è¥å•†	: twnoc.net
æ•°æ®äºŒ	: å°æ¹¾çœæ–°åŒ—å¸‚ | è¿œæŒ¯èµ„è®¯
æ•°æ®ä¸‰	: ä¸­å›½å°æ¹¾æ–°åŒ— | å°æ¹¾å›ºç½‘
```

[^1]: [How To Enable Shell Integration](https://www.iterm2.com/documentation-shell-integration.html)
[^2]: [Scripting Fundamentals](https://www.iterm2.com/documentation-scripting-fundamentals.html)
[^3]: [Badge Format](https://www.iterm2.com/documentation-badges.html)
[^4]: [é€šè¿‡ ProxyChains-NG å®ç°ç»ˆç«¯ä¸‹ä»»æ„åº”ç”¨ä»£ç†](https://www.hi-linux.com/posts/48321.html)